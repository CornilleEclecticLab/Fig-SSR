---
title: "max_membership_coef"
output: html_document
date: "2024-12-16"
---

```{r}

## Set working directory
setwd("/Users/sanzhar/Desktop")

## Define cluster colors
cluster_colors <- c("Cluster1"="#E69F00",
                    "Cluster2"="#56B4E9",
                    "Cluster3"="#009E73",
                    "Cluster4"="#CC79A7",
                    "grey"="#999999")

## Load packages
library(dplyr)
library(ggplot2)

## Threshold for assignment
threshold <- 0.75

## Read metadata
metadata <- read.csv("samples_metadata.csv", stringsAsFactors=FALSE)
head(metadata)

# Extract sample IDs and (if needed) other info
samples <- metadata$sample_id

## Read the k4.q file
qdf_values <- read.table("k4.q", header=FALSE, stringsAsFactors=FALSE)

# Name the columns as Cluster1 ... Cluster4
colnames(qdf_values) <- c("Cluster1","Cluster2","Cluster3","Cluster4")

# Add sample_id from metadata to qdf
qdf <- cbind(sample_id = samples, qdf_values)

# Ensure same number of samples
if(nrow(qdf) != nrow(metadata)) {
  stop("Number of individuals in qdf and metadata do not match!")
}

## Identify cluster columns
cluster_cols <- c("Cluster1","Cluster2","Cluster3","Cluster4")

## Compute max membership and cluster
assignment_df <- qdf %>%
  rowwise() %>%
  mutate(
    max_membership = max(c_across(all_of(cluster_cols))),
    max_cluster = cluster_cols[which.max(c_across(all_of(cluster_cols)))]
  ) %>%
  ungroup()

## Assign populations or "grey" based on threshold
assignment_df <- assignment_df %>%
  mutate(
    assigned_group = ifelse(max_membership >= threshold, max_cluster, "grey")
  )

## Assign colors based on assigned_group
assignment_df$color <- cluster_colors[assignment_df$assigned_group]

## Save assignments to CSV
write.csv(assignment_df, "K4_assignments.csv", row.names=FALSE)

## Plot the distribution of max membership coefficients
# A histogram or density plot can show how many individuals have strong assignment vs. admixture.
ggplot(assignment_df, aes(x=max_membership, fill=assigned_group)) +
  geom_histogram(binwidth=0.05, color="black") +
  scale_fill_manual(values=cluster_colors) +
  theme_minimal() +
  labs(title="Distribution of Max Membership Coefficients (K=4)",
       x="Max Membership Coefficient",
       y="Count",
       fill="Assigned Group") +
  theme(legend.position="bottom")

```

## If you prefer a density plot:


```{r}

ggplot(assignment_df, aes(x=max_membership, fill=assigned_group)) +
 geom_density(alpha=0.5) +
 scale_fill_manual(values=cluster_colors) +
 theme_minimal() +
 labs(title="Density of Max Membership Coefficients (K=4)",
      x="Max Membership Coefficient",
      y="Density",
      fill="Assigned Group") +
 theme(legend.position="bottom")

```

## Barplot with assigned individuals only


```{r}

# assignment_df from previous step, which includes:
#   sample_id, max_membership, max_cluster, assigned_group, and cluster proportions.

library(dplyr)
library(tidyr)
library(ggplot2)
library(ggforce)

# Define the color palette and the new cluster order
cluster_colors <- c("Cluster2"="#56B4E9",
                    "Cluster4"="#CC79A7",
                    "Cluster1"="#E69F00",
                    "Cluster3"="#009E73")

# Filter out grey individuals
assigned_only <- assignment_df %>% 
  filter(assigned_group != "grey")

# Re-factor assigned_group to the new cluster order
assigned_only$assigned_group <- factor(assigned_only$assigned_group, 
                                       levels=c("Cluster2","Cluster4","Cluster1","Cluster3"))

# Join qdf with assigned_only to keep only assigned individuals
qdf_assigned <- qdf %>%
  semi_join(assigned_only, by="sample_id")

# Identify cluster columns
cluster_cols <- c("Cluster1","Cluster2","Cluster3","Cluster4")

# Compute max cluster and membership again (just to confirm order)
qdf_assigned <- qdf_assigned %>%
  rowwise() %>%
  mutate(
    max_membership = max(c_across(all_of(cluster_cols))),
    max_cluster = cluster_cols[which.max(c_across(all_of(cluster_cols)))]
  ) %>%
  ungroup()

# Re-factor max_cluster to the new order
qdf_assigned$max_cluster <- factor(qdf_assigned$max_cluster, 
                                   levels=c("Cluster2","Cluster4","Cluster1","Cluster3"))

# Order samples by max_cluster and then by descending max_membership
qdf_ordered <- qdf_assigned %>%
  arrange(max_cluster, desc(max_membership))

ordered_samples <- qdf_ordered$sample_id

# Pivot longer for plotting the barplot
qdf_long <- qdf_ordered %>%
  pivot_longer(cols=all_of(cluster_cols), names_to="Cluster", values_to="Proportion")

# Make Cluster a factor in the desired order
qdf_long$Cluster <- factor(qdf_long$Cluster, levels=c("Cluster2","Cluster4","Cluster1","Cluster3"))

# Make sample_id a factor with new order
qdf_long$sample_id <- factor(qdf_long$sample_id, levels=ordered_samples)

# Barplot with the new order and only assigned individuals
barplot_gg <- ggplot(qdf_long, aes(x=sample_id, y=Proportion, fill=Cluster)) +
  geom_bar(stat="identity", position="stack", width=1) +
  theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="bottom",
        panel.grid=element_blank()) +
  scale_fill_manual(values=cluster_colors) +
  ggtitle("Admixture Barplot for K=4 - Assigned Individuals Only")

ggsave("K4_barplot_assigned_only.pdf", barplot_gg, width=12, height=6, dpi=300)

```

## Pie charts over map


```{r}

# Focus region for North Africa and Eurasia (adjust as needed)
focus_xlim <- c(-20, 60)
focus_ylim <- c(0, 60)

# Define accessible colors
accessible_colors <- c("Cluster1"="#E69F00",
                       "Cluster2"="#56B4E9",
                       "Cluster3"="#009E73",
                       "Cluster4"="#CC79A7")

# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggforce)
library(maps)

# Set working directory
setwd("/Users/sanzhar/Desktop")  # Adjust if necessary

# Read metadata and k4.q file
metadata <- read.csv("samples_metadata.csv", stringsAsFactors=FALSE)
qdf_values <- read.table("k4.q", header=FALSE, stringsAsFactors=FALSE)

# Add sample names and assign column names for clusters
colnames(qdf_values) <- c("Cluster1", "Cluster2", "Cluster3", "Cluster4")
qdf_values$sample_id <- metadata$sample_id
qdf_values$site_id <- metadata$site_id
qdf_values$latitude <- metadata$latitude
qdf_values$longitude <- metadata$longitude

# Threshold to filter assigned individuals (e.g., >= 0.75 for assignment)
threshold <- 0.75

# Identify max cluster membership for each individual
qdf_assigned <- qdf_values %>%
  rowwise() %>%
  mutate(
    max_membership = max(c_across(starts_with("Cluster"))),
    max_cluster = names(which.max(c_across(starts_with("Cluster"))))
  ) %>%
  ungroup() %>%
  filter(max_membership >= threshold)  # Filter only assigned individuals

# Reshape for plotting
qdf_long <- qdf_assigned %>%
  pivot_longer(cols = starts_with("Cluster"), 
               names_to = "Cluster", 
               values_to = "Proportion") %>%
  group_by(site_id, latitude, longitude, Cluster) %>%
  summarise(mean_prop = mean(Proportion), .groups="drop")

# Compute arcs for pie charts
qdf_pies <- qdf_long %>%
  group_by(site_id, latitude, longitude) %>%
  arrange(Cluster) %>%
  mutate(
    cumulative = cumsum(mean_prop),
    angle_start = lag(cumulative, default = 0),
    angle_end = cumulative
  ) %>%
  ungroup()

# Set pie radius
pie_radius <- 1

# Get world map data
world_map <- map_data("world")

# Plot map with pies
map_pie_plot <- ggplot() +
  geom_polygon(data = world_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_arc_bar(data = qdf_pies,
               aes(x0 = longitude, y0 = latitude, r = pie_radius, r0 = 0,
                   start = angle_start * 2 * pi, end = angle_end * 2 * pi, fill = Cluster),
               color = "black", size = 0.2, alpha = 0.8) +
  scale_fill_manual(values = accessible_colors) +
  coord_sf(xlim = focus_xlim, ylim = focus_ylim, expand = FALSE) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  ggtitle("Map of Mean Admixture Proportions (Assigned Only, K=4)")

# Save the map
ggsave("K4_pie_map_assigned_only.pdf", map_pie_plot, width = 12, height = 8, dpi = 300)


```

```{r}
## Plot the distribution of max membership coefficients with vertical lines
ggplot(assignment_df, aes(x=max_membership, fill=assigned_group)) +
  geom_histogram(binwidth=0.05, color="black") +  # Bin width of 0.05
  scale_fill_manual(values=cluster_colors) +
  geom_vline(xintercept = c(0.75, 0.80, 0.85, 0.90),   # Add vertical lines
             color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = c(0.75, 0.80, 0.85, 0.90), y = Inf, 
           label = c("0.75", "0.80", "0.85", "0.90"), 
           vjust = 1.5, color = "red", size = 4) +  # Add labels to vertical lines
  theme_minimal() +
  labs(title="Distribution of Max Membership Coefficients (K=4)",
       x="Max Membership Coefficient",
       y="Count",
       fill="Assigned Group") +
  theme(legend.position="bottom")
```

